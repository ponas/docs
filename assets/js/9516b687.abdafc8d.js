"use strict";(self.webpackChunkdocs_sikt_no=self.webpackChunkdocs_sikt_no||[]).push([[5977],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function X(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?X(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):X(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},X=Object.keys(e);for(a=0;a<X.length;a++)n=X[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var X=Object.getOwnPropertySymbols(e);for(a=0;a<X.length;a++)n=X[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),l=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(o.Provider,{value:t},e.children)},k={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,X=e.originalType,o=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=l(n),d=r,g=m["".concat(o,".").concat(d)]||m[d]||k[d]||X;return n?a.createElement(g,i(i({ref:t},p),{},{components:n})):a.createElement(g,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var X=n.length,i=new Array(X);i[0]=m;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var l=2;l<X;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7020:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>k,frontMatter:()=>X,metadata:()=>s,toc:()=>l});var a=n(7462),r=(n(7294),n(3905));const X={title:"Maskinporten som token-tjeneste i Gravitee"},i="Maskinporten som token-tjeneste i Gravitee",s={unversionedId:"datadeling/teknisk-plattform/api/maskinporten",id:"datadeling/teknisk-plattform/api/maskinporten",title:"Maskinporten som token-tjeneste i Gravitee",description:"Standardoppsett",source:"@site/docs/datadeling/teknisk-plattform/api/maskinporten.md",sourceDirName:"datadeling/teknisk-plattform/api",slug:"/datadeling/teknisk-plattform/api/maskinporten",permalink:"/docs/datadeling/teknisk-plattform/api/maskinporten",draft:!1,editUrl:"https://github.com/sikt-no/docs/tree/master/docs/datadeling/teknisk-plattform/api/maskinporten.md",tags:[],version:"current",lastUpdatedAt:1673950593,formattedLastUpdatedAt:"Jan 17, 2023",frontMatter:{title:"Maskinporten som token-tjeneste i Gravitee"},sidebar:"datadeling",previous:{title:"Integra",permalink:"/docs/datadeling/teknisk-plattform/api/integra"},next:{title:"Selvbetjening for RabbitMQ",permalink:"/docs/datadeling/teknisk-plattform/brom"}},o={},l=[{value:"Standardoppsett",id:"standardoppsett",level:2},{value:"Hvordan sette opp maskinporten API-et",id:"hvordan-sette-opp-maskinporten-api-et",level:2},{value:"Lokale forberedelser",id:"lokale-forberedelser",level:3},{value:"Konfigurasjonsteg i Samarbeidsportalen",id:"konfigurasjonsteg-i-samarbeidsportalen",level:3},{value:"Konfigurasjons steg i Gravitee",id:"konfigurasjons-steg-i-gravitee",level:3}],p={toc:l};function k(e){let{components:t,...X}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,X,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"maskinporten-som-token-tjeneste-i-gravitee"},"Maskinporten som token-tjeneste i Gravitee"),(0,r.kt)("h2",{id:"standardoppsett"},"Standardoppsett"),(0,r.kt)("p",null,"Dette er standardopsett om man vil opprette en token-tjeneste i API Manager som gir deg token fra maskinporten som du kan bruke\xa0 for \xe5 autentisere mot APIer som krever dette"),(0,r.kt)("p",null,"For mer informasjon og forklaring av oppsett ",(0,r.kt)("a",{parentName:"p",href:"/docs/datadeling/veiledere/api-manager/jwt-mot-backend"},"se denne siden")),(0,r.kt)("h2",{id:"hvordan-sette-opp-maskinporten-api-et"},"Hvordan sette opp maskinporten API-et"),(0,r.kt)("p",null,"For \xe5 sette opp maksinporten APIet s\xe5 trenger man en bruker i ",(0,r.kt)("a",{parentName:"p",href:"https://selvbetjening-samarbeid-ver2.difi.no"},"digitaliseringsdirektoratet sin Samarbeidsportal"),", hvem som helst kan sette opp en integrasjon mot test milj\xf8et til maskinporten.\nFor \xe5 sette opp en integrasjon mot maskinporten produksjon s\xe5 trenger man enten \xe5 bli delegert rollen ",(0,r.kt)("em",{parentName:"p"},"Selvbetjening av integrasjoner i ID-porten/Maskinporten")," av hovedadministratoren til virksomheten vanligvis universitets/h\xf8yskole-direkt\xf8ren, se digidir sin ",(0,r.kt)("a",{parentName:"p",href:"https://docs.digdir.no/docs/Maskinporten/maskinporten_sjolvbetjening_web.html#tilgang-i-produksjonsmilj%C3%B8"},"dokumentasjon for hvordan dette tildeles"),".\nHvis man ikke har tilgang selv s\xe5 kan noen med tilgang gj\xf8re stegene i ",(0,r.kt)("a",{parentName:"p",href:"#Konfigurasjonsteg-i-Samarbeidsportalen"},"konfigurasjonsteg i Samarbeidsportalen")," for deg."),(0,r.kt)("p",null,"Det er testet ut to forskjellige m\xe5ter \xe5 autentisere seg mot maskinporten, den f\xf8rste er ved \xe5 bruke virksomhetssertifikatet, enten ved at sendes til p\xe5 en sikker m\xe5te til IntArk drift, slik at de f\xe5r lastet det opp i filsystemet til gravitee.\nEller ved at man har en mikrotjeneste kj\xf8rende hos seg som leverer sertifikatet til gravitee n\xe5r man gj\xf8r api-kall mot maskinporten."),(0,r.kt)("p",null,"Det andre alternativet som er den vi annbefaler og har dokumentert her er \xe5 benytte seg av en selvsignert n\xf8kkel som man laster opp i Samarbeidsportalen. "),(0,r.kt)("h3",{id:"lokale-forberedelser"},"Lokale forberedelser"),(0,r.kt)("p",null,"For \xe5 lage en egen n\xf8kkel for maskinporten har vi f\xf8lgende steg:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Bruk ssh til \xe5 generere en n\xf8kkel")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ ssh-keygen -t rsa -b 4096 -m PEM -f maskinporten-rs256.key\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Bruk openssl for \xe5 generere en offentlig n\xf8kkel i pem formatet.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ openssl rsa -in maskinporten-rs256.key -pubout -outform PEM -out maskinporten-rs256.key.pub.pem\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Konverter n\xf8kkelen til jwks formatet.\nSamarbeidsportalen krever at alle n\xf8kler som skal lastes opp til bruk med maskinporten er i jwks formatet(JWK = Java Web Key). jwks er en egen base64-formatert presentasjon av offentlige n\xf8kler.\nDet finnes s\xe5 vidt vi vet ingen standard cli-verkt\xf8y som konverterer til/fra jwks, men det finnes verkt\xf8y og kodesnutter online som utf\xf8rer dette.\nVerkt\xf8yene trenger kun den offentlige n\xf8kkelen, s\xe5 burde v\xe6re uproblemtask \xe5 bruke det verkt\xf8yet man selv \xf8nsker.\nVi har brukt ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/jpf/okta-jwks-to-pem.git"},"pem_to_jwks.py")," siden skriptet er lettlest og bruker kjente bibliotek.\nDet finnes en PR som konverter skriptet til python 3 hvis man \xf8nsker versjon av skriptet som er kompatibel med python3 istedenfor python2.",(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"Last ned konverterings verkt\xf8y for eksempel ",(0,r.kt)("inlineCode",{parentName:"li"},"pem_to_jwks.py"),".")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ git clone git@github.com:oyviaase/okta-jwks-to-pem.git\n")),(0,r.kt)("p",null,"for python3 versjonen av skriptet\n2. Utf\xf8r konverteringen."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cd okta-jwks-to-pem\n$ python3 pem_to_jwks.py --kid maskinporten-uio ../maskinporten.key.pub.pem\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"HUSK")," \xe5 notere ned parameteren man setter som ",(0,r.kt)("inlineCode",{parentName:"p"},"--kid")," denne brukes senere n\xe5r man setter opp maskinporten APIet i gravitee."),(0,r.kt)("h3",{id:"konfigurasjonsteg-i-samarbeidsportalen"},"Konfigurasjonsteg i Samarbeidsportalen"),(0,r.kt)("p",null,"Vi antar dette er f\xf8rste gangen noen setter opp maskinporten i samarbeidsportalen, har man allerede satt opp en maskinporten integrasjon der man \xf8nsker \xe5 gjennbruke s\xe5 kan man g\xe5 rett til steg 4."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Logg inn i samarbeidsportalen og velg ",(0,r.kt)("em",{parentName:"li"},"INTEGRASJONER")),(0,r.kt)("li",{parentName:"ol"},"Trykk p\xe5 ",(0,r.kt)("em",{parentName:"li"},"+Ny integrasjon")," og at det st\xe5r ",(0,r.kt)("em",{parentName:"li"},"VER2")," eller ",(0,r.kt)("em",{parentName:"li"},"PRODUKSJON")," i knappen ved siden av se bilde hvis dette ble uklart.\n",(0,r.kt)("a",{target:"_blank",href:n(7066).Z},(0,r.kt)("img",{alt:"Administrer  integrasjoner",src:n(5080).Z,width:"3008",height:"2232"}))),(0,r.kt)("li",{parentName:"ol"},"Fyll ut skjemaet med f\xf8lgende informasjon:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Difi-tjeneste"),": Maskinporten "),(0,r.kt)("li",{parentName:"ul"},"_",(0,r.kt)("em",{parentName:"li"},"Scopes"),": de man trenger(de fleste trenger i alle fall ",(0,r.kt)("inlineCode",{parentName:"li"},"dfo:ansatte"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"dfo:stillinger"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"dfo:ansatte.write")," og ",(0,r.kt)("inlineCode",{parentName:"li"},"dfo:organisasjoner"),") Scope settes ved \xe5 trykke p\xe5 ",(0,r.kt)("em",{parentName:"li"},"Legg til scopes")," knappen "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Navn p\xe5 integrasjonen"),": vi har brukt ",(0,r.kt)("inlineCode",{parentName:"li"},"uio-gravitee-(prod|test)")," avhengig av om det er snakk om maskinporten produksjons milj\xf8 eller maskinporten test milj\xf8."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Beskrivelse"),": hva en du \xf8nsker"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Tillatte grant types"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"urn:ietf:params:oauth:grant-type:jwt-bearer")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Klientautentiseringsmetode"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"private_key_jwt")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Applikasjonstype"),": web "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Authorization levetid (sekunder)"),": 0"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Access token levetid (sekunder)"),": 0"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Refresh token levetid (sekunder)"),": 0"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Refresh token type"),": Engangs")))),(0,r.kt)("p",null,"Eventuelt se illustrasjonen: TODO legg til bilder\n",(0,r.kt)("a",{target:"_blank",href:n(4389).Z},(0,r.kt)("img",{alt:"Lag en ny  integrasjon",src:n(3265).Z,width:"3008",height:"3012"}))),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Last opp jwt n\xf8kkel\nVelg integrasjonen man nettop har laget og trykk p\xe5 ",(0,r.kt)("em",{parentName:"li"},"Egne pulic n\xf8kler")," nesten neders p\xe5 siden, n\xe5 f\xe5r man opp et popupp vindu hvor man limer inn det man fikk ifra steg 3.2 med hakeparanteser rundt alts\xe5")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[<output ifra steg 3.2>]\n")),(0,r.kt)("p",null,"som kan se slik here ut:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'[{"alg": "RS256", "e": "AQAB", "n": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX", "kid": "uio-gravitee-test", "kty": "RSA", "use": "sig"}]\n')),(0,r.kt)("p",null,"   ",(0,r.kt)("a",{target:"_blank",href:n(9489).Z},(0,r.kt)("img",{alt:"Last opp n\xf8kkel",src:n(1973).Z,width:"3108",height:"5130"}))),(0,r.kt)("h3",{id:"konfigurasjons-steg-i-gravitee"},"Konfigurasjons steg i Gravitee"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Kontakt support for \xe5 f\xe5 fil med standardoppsett, og opprett tjenesten i API manager. Se ",(0,r.kt)("a",{parentName:"li",href:"/docs/datadeling/veiledere/api-manager/importer-api"},"veileder for \xe5 registrere en tjeneste i API manager via fil"),"."),(0,r.kt)("li",{parentName:"ol"},"Om dette er mot produksjonsystem i stedet for test, naviger til proxy og endpoint (under backend services) . Klikk p\xe5 tannhjulet for PROD, fjern haken for backup endpoint. Slett TEST eller huk av for at test skal v\xe6re backup endpint. ",(0,r.kt)("strong",{parentName:"li"},"Husk \xe5 lagre")),(0,r.kt)("li",{parentName:"ol"},'G\xe5 p\xe5 design. Klikk p\xe5 policy "Generate JWT" Fyll inn:',(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"_",(0,r.kt)("em",{parentName:"li"},"Key ID"),": det samme parameteren man satte som ",(0,r.kt)("inlineCode",{parentName:"li"},"--kid")," i steg 3.2 i ",(0,r.kt)("a",{parentName:"li",href:"#Lokale-forberedelser"},"Lokale forberedelser")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"audiences"),": hvis produksjon endres den  til",(0,r.kt)("inlineCode",{parentName:"li"},"https://maskinporten.no/")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("em",{parentName:"li"},"Private key")," Den private n\xf8kkelen laget i steg 1 i ",(0,r.kt)("a",{parentName:"li",href:"#Lokale-forberedelser"},"Lokale forberedelser")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Husk \xe5 lagre")))),(0,r.kt)("li",{parentName:"ol"},"G\xe5 til Portal og details. Klikk p\xe5 ",(0,r.kt)("em",{parentName:"li"},"START THE API")," og ",(0,r.kt)("em",{parentName:"li"},"PUBLISH THE API"),". Vi anbefaler at du for dette APIet ikke klikker p\xe5 ",(0,r.kt)("em",{parentName:"li"},"MAKE PUBLIC"))))}k.isMDXComponent=!0},7066:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/Samarbeidsportalen-administrasjon-av-tjeneste-b71739839db1b431571506288a8d9436.png"},9489:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/Samarbeidsportalen-last-opp-nokkel-d93d3d864d457e67fa978eae276f60d0.png"},4389:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/files/Samarbeidsportalen-opprett-tjeneste-233eccc13dc49dad3be869ecd17a4841.png"},5080:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Samarbeidsportalen-administrasjon-av-tjeneste-b71739839db1b431571506288a8d9436.png"},1973:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Samarbeidsportalen-last-opp-nokkel-d93d3d864d457e67fa978eae276f60d0.png"},3265:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Samarbeidsportalen-opprett-tjeneste-233eccc13dc49dad3be869ecd17a4841.png"}}]);